{% extends 'Modulo_usuario/base/base.html' %}

{% block content %}
<div class="container my-5">
    <h2 class="text-center mb-4">Lista de Tickets</h2>
    
    <!-- Botón para crear un nuevo ticket -->
    <div class="d-flex justify-content-end mb-3">
        <a href="{% url 'crear_ticket' %}" class="btn btn-success">Crear Ticket</a>
    </div>
    
    <!-- Tabla para mostrar la lista de tickets -->
    <table class="table table-hover table-bordered">
        <thead class="table-dark">
            <tr>
                <th>Material</th>
                <th>Cantidad</th>
                <th>Estado</th>
                <th>Fecha de Creación</th>
                <th>Acciones</th>
                <th>Eliminar</th>
            </tr>
        </thead>
        <tbody>
            {% if tickets %}
                {% for ticket in tickets %}
                <tr>
                    <!-- Mostrar el nombre del material -->
                    <td>{{ ticket.material_solicitado.nombre }}</td>
                    
                    <!-- Mostrar la cantidad solicitada -->
                    <td>{{ ticket.cantidad }}</td>
                    
                    <!-- Mostrar el estado del ticket -->
                    <td>
                        {% if ticket.estado == 'pendiente' %}
                            <span class="badge bg-warning text-dark">Pendiente</span>
                        {% else %}
                            <span class="badge bg-success">Cobrado</span>
                        {% endif %}
                    </td>
                    
                    <!-- Mostrar la fecha de creación del ticket -->
                    <td>{{ ticket.fecha_creacion|date:"d/m/Y" }}</td>
                    
                    <!-- Acción para cobrar el ticket si está pendiente -->
                    <td>
                        {% if ticket.estado == 'pendiente' %}
                            <a href="{% url 'cobrar_ticket' ticket.id %}" class="btn btn-sm btn-primary" onclick="return confirm('¿Estás seguro de cobrar este ticket?');">
                                Entregar
                            </a>
                        {% else %}
                            <span class="text-muted">Cobrado</span>
                        {% endif %}
                    </td>                    
                    
                    
                    
                    <!-- Acción para eliminar el ticket -->
                    <td>
                        <form action="{% url 'eliminar_ticket' ticket.id %}" method="POST" style="display:inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('¿Estás seguro de eliminar este ticket?');">Eliminar</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="6" class="text-center">No hay tickets disponibles.</td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<script>
    function cobrarTicket(ticketId) {
        if (confirm('¿Estás seguro de cobrar este ticket?')) {
            // Realizar una solicitud AJAX para cobrar el ticket
            fetch(`/cobrar_ticket/${ticketId}/`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Actualizar el estado en la tabla si la respuesta es exitosa
                    const row = document.getElementById(`ticket-${ticketId}`);
                    const estadoCell = row.querySelector('.ticket-estado');
                    estadoCell.innerHTML = '<span class="badge bg-success">Cobrado</span>';
                    
                    // Deshabilitar el botón de "Entregar"
                    const button = row.querySelector('.cobrar-ticket');
                    if (button) {
                        button.outerHTML = '<span class="text-muted">N/A</span>';
                    }
                    
                    alert('Ticket cobrado exitosamente.');
                } else {
                    alert(data.error || 'Error al cobrar el ticket.');
                }
            })
            .catch(error => {
                console.error('Error al procesar la solicitud:', error);
                alert('Ocurrió un error al intentar cobrar el ticket.');
            });
        }
    }
</script>

{% endblock %}
